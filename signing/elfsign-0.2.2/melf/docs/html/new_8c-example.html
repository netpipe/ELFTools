<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Example Documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>new.c</h1>
<p>
Generates a new ELF binary with a few different types of sections.
<p>
<div class="fragment"><pre><font class="preprocessor">#include &lt;stdlib.h&gt;</font>
<font class="preprocessor">#include &lt;stdio.h&gt;</font>

<font class="preprocessor">#include "melf.h"</font>

<font class="keywordtype">int</font> main(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> **argv)
{
        <a name="_a0"></a><a class="code" href="struct__elf__spec__header.html">ELF_SPEC_HEADER</a> *curr, *sym;
        <a name="_a1"></a><a class="code" href="struct__melf.html">MELF</a> *melf = melf_new();

        <font class="keywordflow">if</font> (!melf)
                <font class="keywordflow">return</font> 0;

        fprintf(stdout, <font class="stringliteral">"creating new elf img called 'blank'...\n"</font>);

        melf_elfSetType(melf, ET_EXEC);
        melf_elfSetMachine(melf, EM_386);

        <font class="keywordflow">if</font> ((curr = melf_sectionAdd(melf)))
        {
                melf_sectionSetName(melf, curr, <font class="stringliteral">"test-section"</font>);
                melf_sectionSetType(melf, curr, SHT_NOBITS);
        }
        
        <font class="keywordflow">if</font> ((curr = melf_sectionAdd(melf)))
        {
                melf_sectionSetName(melf, curr, <font class="stringliteral">"bobby"</font>);
                melf_sectionSetType(melf, curr, SHT_NOBITS);
        }

        <font class="comment">// Add a dynamic section</font>
        
        <font class="keywordflow">if</font> ((curr = melf_dynamicCreate(melf)))
        {
                <a class="code" href="struct__elf__spec__header.html">ELF_SPEC_HEADER</a> *dynstr = melf_sectionGetStringTableHeader(melf, curr);
                <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> index = 0;

                <font class="comment">// Add DT_NEEDED for libc.</font>
                <font class="keywordflow">if</font> (dynstr)
                        index = melf_stringTableSetString(melf, dynstr, <font class="stringliteral">"/lib/libc.so.6"</font>);

                melf_dynamicAddTag(melf, curr, DT_NEEDED, index);
        }

        <font class="comment">// Add a note section</font>

        <font class="keywordflow">if</font> ((curr = melf_noteCreate(melf, <font class="stringliteral">".note"</font>, 1)))
        {
                melf_noteAdd(melf, curr, 1, <font class="stringliteral">"hi"</font>, <font class="stringliteral">"testing"</font>, 8);
                melf_noteAdd(melf, curr, 0, <font class="stringliteral">"NAME"</font>, <font class="stringliteral">"DESC"</font>, 5);
                melf_noteAdd(melf, curr, 1, <font class="stringliteral">"JANE"</font>, <font class="stringliteral">"DESCZ"</font>, 5);
        }

        <font class="comment">// Add a symbol table</font>
        
        <font class="keywordflow">if</font> ((curr = sym = melf_symbolTableCreate(melf, <font class="stringliteral">".symtab"</font>)))
        {
                Elf32_Sym *sym = melf_symbolTableAddSymbol(melf, curr, <font class="stringliteral">"tester"</font>);
                sym = melf_symbolTableAddSymbol(melf, curr, <font class="stringliteral">"shutup"</font>);

                melf_symbolSetType(melf, curr, sym, STT_OBJECT);
                melf_symbolSetBinding(melf, curr, sym, STB_GLOBAL);
        }

        <font class="comment">// Reloc table</font>
        <font class="keywordflow">if</font> ((curr = melf_relocTableCreate(melf, <font class="stringliteral">".rel"</font>, 0)))
        {
                Elf32_Rel *rel = melf_relocTableAddRel(melf, curr);
                melf_relocRelInitialize(melf, curr, rel, 0x41, 1, 1);
                
                rel = melf_relocTableAddRel(melf, curr);
                melf_relocRelInitialize(melf, curr, rel, 0x4411, 2, 2);
                
                rel = melf_relocTableAddRel(melf, curr);
                melf_relocRelInitialize(melf, curr, rel, 0x4411, 8, 0);

                melf_relocTableRemoveRel(melf, curr, melf_relocTableEnumRel(melf, curr, 1));

                melf_relocTableSetSymbolTableHeader(melf, curr, sym);
        }

        <font class="comment">// Reloc addend table</font>
        <font class="keywordflow">if</font> ((curr = melf_relocTableCreate(melf, <font class="stringliteral">".rela"</font>, 1)))
        {
                Elf32_Rela *rela = melf_relocTableAddRela(melf, curr);

                melf_relocRelaInitialize(melf, curr, rela, 0x41, 1, 1, 0xffff);

                rela = melf_relocTableAddRela(melf, curr);
                melf_relocRelaInitialize(melf, curr, rela, 0x4441, 1, 2, 0xfffe);
                
                rela = melf_relocTableAddRela(melf, curr);
                melf_relocRelaInitialize(melf, curr, rela, 0x4444, 7, 3, 0xfffe);

                melf_relocTableRemoveRela(melf, curr, melf_relocTableEnumRela(melf, curr, 1));

                melf_relocTableSetSymbolTableHeader(melf, curr, sym);
        }

        melf_save(melf, <font class="stringliteral">"blank"</font>);

        melf_destroy(melf);

        <font class="keywordflow">return</font> 1;
}
</pre></div><hr><address align="right"><small>Generated on Tue May 4 00:14:34 2004 for libmelf by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
